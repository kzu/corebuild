<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Update" InitialTargets="_VerifyInputs" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<PS Condition="'$(PowerShell)' == ''">%WINDIR%\System32\WindowsPowerShell\v1.0\powershell.exe</PS>
		<Curl Condition="'$(Curl)' == ''">curl -k -f -L</Curl>
		<_XmlNs>&lt;Namespace Prefix='msb' Uri='http://schemas.microsoft.com/developer/msbuild/2003'/&gt;</_XmlNs>
		<_SelfBaseUrl>https://raw.githubusercontent.com/kzu/corebuild/master/build/corebuild</_SelfBaseUrl>
		<_Self>$(MSBuildThisFileFullPath)</_Self>
		<_SelfUrl>$(_SelfBaseUrl)/$(MSBuildThisFilename)$(MSBuildThisFileExtension)</_SelfUrl>

		<UpdateDependsOn>
			_ReadLocalEtag;
			_FetchRemoteEtag;
			_UpdateLocalFile;
			_UpdateEtagStatus
		</UpdateDependsOn>
	</PropertyGroup>

	<Target Name="Update" DependsOnTargets="$(UpdateDependsOn)" Returns="$(_LocalEtag)" />

	<Target Name="_ReadLocalEtag">
		<XmlPeek Namespaces="$(_XmlNs)"
				 XmlInputPath="$(_Self)"
				 Query="/msb:Project/msb:PropertyGroup/msb:Etag/text()">
			<Output TaskParameter="Result" PropertyName="_LocalEtag" />
		</XmlPeek>
	</Target>

	<Target Name="_FetchRemoteEtag" DependsOnTargets="_FetchRemoteEtagPS;_FetchRemoteEtagCurl" />

	<Target Name="_FetchRemoteEtagPS">
		<Exec Command='"$(PS)" -NoProfile -Command "&amp; { (Invoke-WebRequest -Uri $(_SelfUrl) -Method HEAD).Headers.ETag }"'
			  StandardOutputImportance="low"
			  EchoOff="true"
			  ConsoleToMSBuild="true">
			<Output TaskParameter="ConsoleOutput" PropertyName="_RemoteEtag"/>
		</Exec>
		<PropertyGroup>
			<_RemoteEtag>$(_RemoteEtag.Trim('&quot;'))</_RemoteEtag>
		</PropertyGroup>
	</Target>
	
	<Target Name="_FetchRemoteEtagCurl" Condition="'$(OS)' != 'Windows_NT'">
		<Exec Command='$(Curl) -I "$(_SelfUrl)"'
			  StandardOutputImportance='low'
			  ConsoleToMSBuild="true">
			<Output TaskParameter="ConsoleOutput" ItemName="HttpResponse"/>
		</Exec>

		<ItemGroup>
			<!-- Each line becomes an item, filter the one for ETag header -->
			<_RemoteEtag Include="@(HttpResponse)" Condition="$([System.String]::new('%(Identity)').StartsWith('ETag:')) " />
		</ItemGroup>
		<PropertyGroup>
			<!-- Turn the item into a property, so we can do property functions on it -->
			<_RemoteEtag>@(_RemoteEtag)</_RemoteEtag>
			<_RemoteEtag>$(_RemoteEtag.Substring(5).Trim().TrimStart('"').TrimEnd('"'))</_RemoteEtag>
		</PropertyGroup>
	</Target>

	<Target Name="_UpdateLocalFile" Condition="'$(_LocalEtag)' != '$(_RemoteEtag)'">
		<Exec Command='$(Curl) -o "$(_Self)" "$(_SelfUrl)"'
			  Condition="'$(OS)' != 'Windows_NT'"/>

		<Exec Command='"$(PS)" -NoProfile -Command "&amp; { Invoke-WebRequest -Uri $(_SelfUrl) -OutFile &quot;$(_Self)&quot; }"'
			  EchoOff="true"
			  Condition="'$(OS)' == 'Windows_NT'" />

		<!-- NOTE: known issue, XmlPoke removes the whitespace, 
			 but then users aren't intended to edit the updated 
			 file but the one on the repo instead, via PRs :) -->
		<XmlPoke Namespaces="$(_XmlNs)"
				 XmlInputPath="$(_Self)"
				 Query="/msb:Project/msb:PropertyGroup/msb:Etag"
				 Value="$(_RemoteEtag)" />
	</Target>

	<Target Name="_UpdateEtagStatus" Returns="$(_LocalEtag)">
		<Message Importance="high"
				 Text="New version found, updated $(_Self)."
				 Condition="'$(_LocalEtag)' != '$(_RemoteEtag)'" />	 
		<Message Importance="high"
				 Text="No updates found for $(_Self)."
				 Condition="'$(_LocalEtag)' == '$(_RemoteEtag)'" />

		<PropertyGroup Condition="'$(_LocalEtag)' != '$(_RemoteEtag)'">
			<_LocalEtag>$(_RemoteEtag)</_LocalEtag>
		</PropertyGroup>
	</Target>
	
	<Target Name="_VerifyInputs">
		<!-- Ensure PowerShell v3+ -->
		<Exec Command='$(PS) -NoProfile -Command "&amp; { exit [int]($PSVersionTable.PSVersion.Major -lt 3) }"'
			  IgnoreExitCode="true"
			  EchoOff="true"
			  Condition="'$(OS)' == 'Windows_NT'">
			<Output TaskParameter="ExitCode" PropertyName="LastExitCode" />
		</Exec>
		<Error Condition="'$(LastExitCode)' != '0'" Text="Powershell v3 or greater is required on Windows." />

		<!-- Should fail on *nix if curl isn't found. -->
		<Exec Command="command -v curl" Condition="'$(OS)' != 'Windows_NT'"
			  StandardOutputImportance="low" />
	</Target>

	<PropertyGroup>
		<UpdaterImported>true</UpdaterImported>
		<Etag Condition="'$(Etag)' == ''">asdf</Etag>
	</PropertyGroup>

	<Import Project="XmlPoke.targets" Condition="'$(XmlPokeImported)' != 'true'" />
</Project>